
Has_many_polymorphs

An ActiveRecord plugin for self-referential and double-sided polymorphic associations.

== License

Copyright 2007 Cloudburst, LLC. Licensed under the AFL 3. See the included LICENSE file. 

== Description

This plugin lets you define self-referential and double-sided polymorphic associations in your models. It is an extension of <tt>has_many :through</tt>.

“Polymorphic” means an association can freely point to any of several unrelated model classes, instead of being tied to one particular class.

== Features

* self-references
* double-sided polymorphism
* efficient, merged association SELECT
* STI support
* namespace support
* automatic individual and reverse associations

The plugin also includes a generator for a tagging system, a common use case (see below).

== Requirements

* Rails 1.2.3 or greater

= Usage

== Installation

To install the Rails plugin, run:
  script/plugin install svn://rubyforge.org/var/svn/fauna/has_many_polymorphs/trunk

There's also a gem version. To install it instead, run: 
  sudo gem install has_many_polymorphs
  
If you are using the gem, make sure to add <tt>require 'has_many_polymorphs'</tt> to <tt>environment.rb</tt>, before Rails::Initializer block.

== Configuration

Setup the parent model as so:

  class Petfood < ActiveRecord::Base
    has_many_polymorphs :eaters, :from => [:dogs, :cats, :birds]
  end

The join model:

  class EatersPetfood < ActiveRecord::Base
    belongs_to :petfood
    belongs_to :eater, :polymorphic => true
  end

One of the child models:

  class Dog < ActiveRecord::Base
    # nothing
  end

See ActiveRecord::Associations::PolymorphicClassMethods for more configuration options.

== Helper methods example

  petfood = Petfood.find(1)
  petfood.eaters.map(&:class) # => [Dog, Cat, Cat, Bird]
  
  petfood.eaters.push(Cat.create)
  petfood.eaters << Cat.create
  petfood.cats.size # => 4
  petfood.eaters.size # => 6
  
  petfood.eaters.delete(petfood.dogs[0])
  petfood.dogs.size # => 0
  petfood.eaters.size # => 5

  # works both ways
  petfood.eaters[0].petfoods.include?(petfood) # => true

See ActiveRecord::Associations::PolymorphicAssociation for more helper method details.

= Extras

== Double-sided polymorphism

Double-sided relationships are defined on the join model:

  class Devouring < ActiveRecord::Base
    belongs_to :eater, :polymorphic => true
    belongs_to :eaten, :polymorphic => true
  
    acts_as_double_polymorphic_join(
      :eaters =>[:dogs, :cats], 
      :eatens => [:cats, :birds]
    )       
  end
  
Now, dogs and cats can eat birds and cats. Birds can't eat anything (they aren't <tt>eaters</tt>) and dogs can't be eaten by anything (since they aren't <tt>eatens</tt>). The keys stand for what the models are, not what they do. 

In this case, each eater/eaten relationship is called a Devouring.

See ActiveRecord::Associations::PolymorphicClassMethods for more.

== Tagging generator

Has_many_polymorphs includes a tagging system generator. Run:
  script/generate tagging Dog Cat [...MoreModels...]

This adds a migration and new Tag and Tagging models in <tt>app/models</tt>. It configures Tag with an appropriate <tt>has_many_polymorphs</tt> call against the models you list at the command line. It also adds the file <tt>lib/tagging_extensions.rb</tt> and <tt>requires</tt> it in <tt>environment.rb</tt>. 

Tests will also be generated. 

Once you've run the generator, you can tag records as follows:

  >> d = Dog.create(:name => "Rover")
  #<Dog id: 3, name: "Rover">
  >> d.tag_list
  ""
  >> d.tag_with "fierce loud"
  #<Dog id: 3, name: "Rover">
  >> d.tag_list
  "fierce loud"
  >> c = Cat.create(:name => "Chloe")
  #<Cat id: 1, name: "Chloe">
  >> c.tag_with "fierce cute"
  #<Cat id: 1, name: "Chloe">
  >> c.tag_list
  "cute fierce"
  >> Tag.find_by_name("fierce").taggables 
  [#<Cat id: 1, name: "Chloe">, #<Dog id: 3, name: "Rover">]

The generator accepts the optional flag <tt>--skip-migration</tt> to skip generating a migration (for example, if you are converting from <tt>acts_as_taggable</tt>). It also accepts the flag <tt>--self-referential</tt> if you want to be able to tag tags.

See ActiveRecord::Base::TaggingExtensions, Tag, and Tagging for more.

== Troubleshooting

Some debugging tools are available in <tt>lib/has_many_polymorphs/debugging_tools.rb</tt>.

If you are having trouble, think very carefully about how your model classes, key columns, and table names relate. You may have to explicitly specify options on your join model such as <tt>:class_name</tt>, <tt>:foreign_key</tt>, or <tt>:as</tt>. The included tests are a good place to look for examples.

Note that because of the way Rails reloads model classes, the plugin can sometimes bog down your development server. Set <tt>config.cache_classes = true</tt> in <tt>config/environments/development.rb</tt> to avoid this. 

== Further resources

* http://blog.evanweaver.com/pages/code#polymorphs
* http://rubyforge.org/forum/forum.php?forum_id=16450
